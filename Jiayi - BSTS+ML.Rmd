---
title: "TS_finalproject"
output: html_document
date: "2024-05-14"
---

# Preprocessnig
```{r}
data <- read.csv('baggagecomplaints.csv')
data$bag_rate <- data$Baggage / data$Enplaned
data$cancel_rate <- data$Cancelled / data$Scheduled
data$Date <- as.Date(paste(data$Year, data$Month, "01", sep = "-"))
```

```{r}
airlines <- unique(data$Airline)
airline_data_frames <- list()
for (airline in airlines) {
  airline_data_frames[[airline]] <- subset(data, Airline == airline)
}
```

```{r}
ae <- airline_data_frames[['American Eagle']]
haw <- airline_data_frames[['Hawaiian']]
uni <- airline_data_frames[['United']]
```

# BSTS

## American Eagle
```{r}
library(lubridate)
training_set <- subset(ae, Year < 2010)
test_set <- subset(ae, Year == 2010)
```

First, try linear trend
```{r}
library(bsts)
formula <- as.formula(Baggage ~ Scheduled + Cancelled + Enplaned)
ss <- AddLocalLinearTrend(list(), training_set$Baggage)

# Fit the BSTS model
model <- bsts(formula, state.specification = ss, data = training_set, niter = 1000)

newdata <- test_set[, c("Scheduled", "Cancelled", "Enplaned")]

prediction <- predict(model, n.ahead = nrow(test_set), newdata = newdata)

predicted_values <- as.numeric(prediction$mean)

actual_values <- test_set$Baggage

mae <- mean(abs(predicted_values - actual_values))
mse <- mean((predicted_values - actual_values)^2)
rmse <- sqrt(mse)
mape <- mean(abs((predicted_values - actual_values) / actual_values)) * 100

print(paste("MAE:", mae))
print(paste("RMSE:", rmse))
print(paste("MAPE:", mape))
```


Try dynamic regression
```{r}
# Adding dynamic regression components
# This includes all three variables: Scheduled, Cancelled, Enplaned
ss <- AddDynamicRegression(formula = Baggage ~ Scheduled + Cancelled, data = training_set)

# Fit the BSTS model
model <- bsts(Baggage ~ Cancelled, state.specification = ss, data = training_set, niter = 1000)

newdata <- test_set[, c("Scheduled", "Cancelled")]

prediction <- predict(model, n.ahead = nrow(test_set), newdata = newdata)

predicted_values <- as.numeric(prediction$mean)

actual_values <- test_set$Baggage

mae <- mean(abs(predicted_values - actual_values))
mse <- mean((predicted_values - actual_values)^2)
rmse <- sqrt(mse)
mape <- mean(abs((predicted_values - actual_values) / actual_values)) * 100

print(paste("MAE:", mae))
print(paste("RMSE:", rmse))
print(paste("MAPE:", mape))
```
Try dynamic regression and local level
```{r}
ss <- list()

# Add a local linear trend
ss <- AddLocalLevel(ss, training_set$Baggage)

# ss <- AddDynamicRegression(ss, formula = Baggage ~ Scheduled + Cancelled + Enplaned, data = training_set)
ss <- AddDynamicRegression(ss, formula = Baggage ~ Scheduled + Cancelled, data = training_set)

# Fit the BSTS model
# We use only an intercept in the formula since the focus is on trend and volatility
model <- bsts(Baggage ~ 1, state.specification = ss, data = training_set, niter = 1000)

newdata <- test_set[, c("Scheduled", "Cancelled")]

prediction <- predict(model, n.ahead = nrow(test_set), newdata = newdata)

predicted_values <- as.numeric(prediction$mean)

actual_values <- test_set$Baggage

mae <- mean(abs(predicted_values - actual_values))
mse <- mean((predicted_values - actual_values)^2)
rmse <- sqrt(mse)
mape <- mean(abs((predicted_values - actual_values) / actual_values)) * 100

print(paste("MAE:", mae))
print(paste("RMSE:", rmse))
print(paste("MAPE:", mape))
```
Try Ar and local linear trend
```{r}
ss <- list()
ss <- AddLocalLinearTrend(ss, training_set$Baggage)

# Add an AR component with a known order, for example AR(1)
ss <- AddAr(ss, y = training_set$Baggage, lags = 1)

# Fit the BSTS model
model <- bsts(Baggage ~ 1, state.specification = ss, data = training_set, niter = 1000)

newdata <- test_set[, c("Scheduled", "Cancelled", "Enplaned")]

prediction <- predict(model, n.ahead = nrow(test_set), newdata = newdata)

predicted_values <- as.numeric(prediction$mean)

actual_values <- test_set$Baggage

mae <- mean(abs(predicted_values - actual_values))
mse <- mean((predicted_values - actual_values)^2)
rmse <- sqrt(mse)
mape <- mean(abs((predicted_values - actual_values) / actual_values)) * 100

print(paste("MAE:", mae))
print(paste("RMSE:", rmse))
print(paste("MAPE:", mape))
```
## Hawaii
```{r}
library(lubridate)
training_set <- subset(haw, Year < 2010)
test_set <- subset(haw, Year == 2010)
```

First, try linear trend
```{r}
library(bsts)
formula <- as.formula(Baggage ~ Scheduled + Cancelled + Enplaned)
ss <- AddLocalLinearTrend(list(), training_set$Baggage)

# Fit the BSTS model
model <- bsts(formula, state.specification = ss, data = training_set, niter = 1000)

newdata <- test_set[, c("Scheduled", "Cancelled", "Enplaned")]

prediction <- predict(model, n.ahead = nrow(test_set), newdata = newdata)

predicted_values <- as.numeric(prediction$mean)

actual_values <- test_set$Baggage

mae <- mean(abs(predicted_values - actual_values))
mse <- mean((predicted_values - actual_values)^2)
rmse <- sqrt(mse)
mape <- mean(abs((predicted_values - actual_values) / actual_values)) * 100

print(paste("MAE:", mae))
print(paste("RMSE:", rmse))
print(paste("MAPE:", mape))
```


Try dynamic regression
```{r}
# Adding dynamic regression components
# This includes all three variables: Scheduled, Cancelled, Enplaned
ss <- AddDynamicRegression(formula = Baggage ~ Scheduled + Cancelled, data = training_set)

# Fit the BSTS model
model <- bsts(Baggage ~ Cancelled, state.specification = ss, data = training_set, niter = 1000)

newdata <- test_set[, c("Scheduled", "Cancelled")]

prediction <- predict(model, n.ahead = nrow(test_set), newdata = newdata)

predicted_values <- as.numeric(prediction$mean)

actual_values <- test_set$Baggage

mae <- mean(abs(predicted_values - actual_values))
mse <- mean((predicted_values - actual_values)^2)
rmse <- sqrt(mse)
mape <- mean(abs((predicted_values - actual_values) / actual_values)) * 100

print(paste("MAE:", mae))
print(paste("RMSE:", rmse))
print(paste("MAPE:", mape))
```
Try dynamic regression and local level
```{r}
ss <- list()

# Add a local linear trend
ss <- AddLocalLevel(ss, training_set$Baggage)

# ss <- AddDynamicRegression(ss, formula = Baggage ~ Scheduled + Cancelled + Enplaned, data = training_set)
ss <- AddDynamicRegression(ss, formula = Baggage ~ Scheduled + Cancelled, data = training_set)

# Fit the BSTS model
# We use only an intercept in the formula since the focus is on trend and volatility
model <- bsts(Baggage ~ 1, state.specification = ss, data = training_set, niter = 1000)

newdata <- test_set[, c("Scheduled", "Cancelled")]

prediction <- predict(model, n.ahead = nrow(test_set), newdata = newdata)

predicted_values <- as.numeric(prediction$mean)

actual_values <- test_set$Baggage

mae <- mean(abs(predicted_values - actual_values))
mse <- mean((predicted_values - actual_values)^2)
rmse <- sqrt(mse)
mape <- mean(abs((predicted_values - actual_values) / actual_values)) * 100

print(paste("MAE:", mae))
print(paste("RMSE:", rmse))
print(paste("MAPE:", mape))
```
Try Ar and local linear trend
```{r}
ss <- list()
ss <- AddLocalLinearTrend(ss, training_set$Baggage)

# Add an AR component with a known order, for example AR(1)
ss <- AddAr(ss, y = training_set$Baggage, lags = 1)

# Fit the BSTS model
model <- bsts(Baggage ~ 1, state.specification = ss, data = training_set, niter = 1000)

newdata <- test_set[, c("Scheduled", "Cancelled", "Enplaned")]

prediction <- predict(model, n.ahead = nrow(test_set), newdata = newdata)

predicted_values <- as.numeric(prediction$mean)

actual_values <- test_set$Baggage

mae <- mean(abs(predicted_values - actual_values))
mse <- mean((predicted_values - actual_values)^2)
rmse <- sqrt(mse)
mape <- mean(abs((predicted_values - actual_values) / actual_values)) * 100

print(paste("MAE:", mae))
print(paste("RMSE:", rmse))
print(paste("MAPE:", mape))
```
## United
```{r}
library(lubridate)
training_set <- subset(uni, Year < 2010)
test_set <- subset(uni, Year == 2010)
```

First, try linear trend
```{r}
library(bsts)
formula <- as.formula(Baggage ~ Scheduled + Cancelled + Enplaned)
ss <- AddLocalLinearTrend(list(), training_set$Baggage)

# Fit the BSTS model
model <- bsts(formula, state.specification = ss, data = training_set, niter = 1000)

newdata <- test_set[, c("Scheduled", "Cancelled", "Enplaned")]

prediction <- predict(model, n.ahead = nrow(test_set), newdata = newdata)

predicted_values <- as.numeric(prediction$mean)

actual_values <- test_set$Baggage

mae <- mean(abs(predicted_values - actual_values))
mse <- mean((predicted_values - actual_values)^2)
rmse <- sqrt(mse)
mape <- mean(abs((predicted_values - actual_values) / actual_values)) * 100

print(paste("MAE:", mae))
print(paste("RMSE:", rmse))
print(paste("MAPE:", mape))
```


Try dynamic regression
```{r}
# Adding dynamic regression components
# This includes all three variables: Scheduled, Cancelled, Enplaned
ss <- AddDynamicRegression(formula = Baggage ~ Scheduled + Cancelled, data = training_set)

# Fit the BSTS model
model <- bsts(Baggage ~ Cancelled, state.specification = ss, data = training_set, niter = 1000)

newdata <- test_set[, c("Scheduled", "Cancelled")]

prediction <- predict(model, n.ahead = nrow(test_set), newdata = newdata)

predicted_values <- as.numeric(prediction$mean)

actual_values <- test_set$Baggage

mae <- mean(abs(predicted_values - actual_values))
mse <- mean((predicted_values - actual_values)^2)
rmse <- sqrt(mse)
mape <- mean(abs((predicted_values - actual_values) / actual_values)) * 100

print(paste("MAE:", mae))
print(paste("RMSE:", rmse))
print(paste("MAPE:", mape))
```
Try dynamic regression and local level
```{r}
ss <- list()

# Add a local linear trend
ss <- AddLocalLevel(ss, training_set$Baggage)

# ss <- AddDynamicRegression(ss, formula = Baggage ~ Scheduled + Cancelled + Enplaned, data = training_set)
ss <- AddDynamicRegression(ss, formula = Baggage ~ Scheduled + Cancelled, data = training_set)

# Fit the BSTS model
# We use only an intercept in the formula since the focus is on trend and volatility
model <- bsts(Baggage ~ 1, state.specification = ss, data = training_set, niter = 1000)

newdata <- test_set[, c("Scheduled", "Cancelled")]

prediction <- predict(model, n.ahead = nrow(test_set), newdata = newdata)

predicted_values <- as.numeric(prediction$mean)

actual_values <- test_set$Baggage

mae <- mean(abs(predicted_values - actual_values))
mse <- mean((predicted_values - actual_values)^2)
rmse <- sqrt(mse)
mape <- mean(abs((predicted_values - actual_values) / actual_values)) * 100

print(paste("MAE:", mae))
print(paste("RMSE:", rmse))
print(paste("MAPE:", mape))
```
Try Ar and local linear trend
```{r}
ss <- list()
ss <- AddLocalLinearTrend(ss, training_set$Baggage)

# Add an AR component with a known order, for example AR(1)
ss <- AddAr(ss, y = training_set$Baggage, lags = 1)

# Fit the BSTS model
model <- bsts(Baggage ~ 1, state.specification = ss, data = training_set, niter = 1000)

newdata <- test_set[, c("Scheduled", "Cancelled", "Enplaned")]

prediction <- predict(model, n.ahead = nrow(test_set), newdata = newdata)

predicted_values <- as.numeric(prediction$mean)

actual_values <- test_set$Baggage

mae <- mean(abs(predicted_values - actual_values))
mse <- mean((predicted_values - actual_values)^2)
rmse <- sqrt(mse)
mape <- mean(abs((predicted_values - actual_values) / actual_values)) * 100

print(paste("MAE:", mae))
print(paste("RMSE:", rmse))
print(paste("MAPE:", mape))
```
# Machine Learning

## American Eagle
```{r}
library(lubridate)
training_set <- subset(ae, Year < 2010)
test_set <- subset(ae, Year == 2010)
```

```{r}
library(glmnet)

# Prepare matrix for glmnet
x_train <- model.matrix(Baggage ~ Scheduled + Cancelled + Enplaned -1, data = training_set)  # -1 to exclude intercept
y_train <- training_set$Baggage

# Fit Ridge Regression
ridge_model <- glmnet(x_train, y_train, alpha = 0)

# Fit Lasso Regression
lasso_model <- glmnet(x_train, y_train, alpha = 1)

# Install and load randomForest
library(randomForest)

# Fit Random Forest
rf_model <- randomForest(Baggage ~ Scheduled + Cancelled + Enplaned, data = training_set, ntree = 500)

library(gbm)

# Fit GBM
gbm_model <- gbm(Baggage ~ Scheduled + Cancelled + Enplaned, data = training_set, distribution = "gaussian", n.trees = 500, interaction.depth = 3, shrinkage = 0.01)
```

```{r}
# Prepare test data
x_test <- model.matrix(Baggage ~ Scheduled + Cancelled + Enplaned -1, data = test_set)  # -1 to exclude intercept
y_test <- test_set$Baggage

# Predictions
predict_ridge <- predict(ridge_model, s = 0.01, newx = x_test)
predict_lasso <- predict(lasso_model, s = 0.01, newx = x_test)
predict_rf <- predict(rf_model, newdata = test_set)
predict_gbm <- predict(gbm_model, newdata = test_set, n.trees = 500)

# Function to calculate MAE, RMSE, MAPE
evaluate_model <- function(predictions, actuals) {
  mae <- mean(abs(predictions - actuals))
  rmse <- sqrt(mean((predictions - actuals)^2))
  mape <- mean(abs((predictions - actuals) / actuals)) * 100
  return(c(MAE = mae, RMSE = rmse, MAPE = mape))
}

# Apply evaluation
results_ridge <- evaluate_model(predict_ridge, y_test)
results_lasso <- evaluate_model(predict_lasso, y_test)
results_rf <- evaluate_model(predict_rf, y_test)
results_gbm <- evaluate_model(predict_gbm, y_test)

# Print results
print(results_ridge)
print(results_lasso)
print(results_rf)
print(results_gbm)
```

## Hawaii
```{r}
library(lubridate)
training_set <- subset(haw, Year < 2010)
test_set <- subset(haw, Year == 2010)
```

```{r}
library(glmnet)

# Prepare matrix for glmnet
x_train <- model.matrix(Baggage ~ Scheduled + Cancelled + Enplaned -1, data = training_set)  # -1 to exclude intercept
y_train <- training_set$Baggage

# Fit Ridge Regression
ridge_model <- glmnet(x_train, y_train, alpha = 0)

# Fit Lasso Regression
lasso_model <- glmnet(x_train, y_train, alpha = 1)

# Install and load randomForest
library(randomForest)

# Fit Random Forest
rf_model <- randomForest(Baggage ~ Scheduled + Cancelled + Enplaned, data = training_set, ntree = 500)

library(gbm)

# Fit GBM
gbm_model <- gbm(Baggage ~ Scheduled + Cancelled + Enplaned, data = training_set, distribution = "gaussian", n.trees = 500, interaction.depth = 3, shrinkage = 0.01)
```

```{r}
# Prepare test data
x_test <- model.matrix(Baggage ~ Scheduled + Cancelled + Enplaned -1, data = test_set)  # -1 to exclude intercept
y_test <- test_set$Baggage

# Predictions
predict_ridge <- predict(ridge_model, s = 0.01, newx = x_test)
predict_lasso <- predict(lasso_model, s = 0.01, newx = x_test)
predict_rf <- predict(rf_model, newdata = test_set)
predict_gbm <- predict(gbm_model, newdata = test_set, n.trees = 500)

# Function to calculate MAE, RMSE, MAPE
evaluate_model <- function(predictions, actuals) {
  mae <- mean(abs(predictions - actuals))
  rmse <- sqrt(mean((predictions - actuals)^2))
  mape <- mean(abs((predictions - actuals) / actuals)) * 100
  return(c(MAE = mae, RMSE = rmse, MAPE = mape))
}

# Apply evaluation
results_ridge <- evaluate_model(predict_ridge, y_test)
results_lasso <- evaluate_model(predict_lasso, y_test)
results_rf <- evaluate_model(predict_rf, y_test)
results_gbm <- evaluate_model(predict_gbm, y_test)

# Print results
print(results_ridge)
print(results_lasso)
print(results_rf)
print(results_gbm)
```
## United
```{r}
library(lubridate)
training_set <- subset(uni, Year < 2010)
test_set <- subset(uni, Year == 2010)
```

```{r}
library(glmnet)

# Prepare matrix for glmnet
x_train <- model.matrix(Baggage ~ Scheduled + Cancelled + Enplaned -1, data = training_set)  # -1 to exclude intercept
y_train <- training_set$Baggage

# Fit Ridge Regression
ridge_model <- glmnet(x_train, y_train, alpha = 0)

# Fit Lasso Regression
lasso_model <- glmnet(x_train, y_train, alpha = 1)

# Install and load randomForest
library(randomForest)

# Fit Random Forest
rf_model <- randomForest(Baggage ~ Scheduled + Cancelled + Enplaned, data = training_set, ntree = 500)

library(gbm)

# Fit GBM
gbm_model <- gbm(Baggage ~ Scheduled + Cancelled + Enplaned, data = training_set, distribution = "gaussian", n.trees = 500, interaction.depth = 3, shrinkage = 0.01)
```

```{r}
# Prepare test data
x_test <- model.matrix(Baggage ~ Scheduled + Cancelled + Enplaned -1, data = test_set)  # -1 to exclude intercept
y_test <- test_set$Baggage

# Predictions
predict_ridge <- predict(ridge_model, s = 0.01, newx = x_test)
predict_lasso <- predict(lasso_model, s = 0.01, newx = x_test)
predict_rf <- predict(rf_model, newdata = test_set)
predict_gbm <- predict(gbm_model, newdata = test_set, n.trees = 500)

# Function to calculate MAE, RMSE, MAPE
evaluate_model <- function(predictions, actuals) {
  mae <- mean(abs(predictions - actuals))
  rmse <- sqrt(mean((predictions - actuals)^2))
  mape <- mean(abs((predictions - actuals) / actuals)) * 100
  return(c(MAE = mae, RMSE = rmse, MAPE = mape))
}

# Apply evaluation
results_ridge <- evaluate_model(predict_ridge, y_test)
results_lasso <- evaluate_model(predict_lasso, y_test)
results_rf <- evaluate_model(predict_rf, y_test)
results_gbm <- evaluate_model(predict_gbm, y_test)

# Print results
print(results_ridge)
print(results_lasso)
print(results_rf)
print(results_gbm)
```





